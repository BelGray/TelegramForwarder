# Telegram Smart Broadcaster v3.0 (Enterprise Edition)

**Техническая документация и руководство по эксплуатации**

## 1. Общее описание системы

**Telegram Smart Broadcaster** — это серверное программное обеспечение для автоматизированного управления контентом в сети Telegram-каналов. Система построена на архитектуре «Ротатора» (Polling), что обеспечивает автономную работу, высокую отказоустойчивость и независимость от человеческого фактора.

### Ключевые особенности архитектуры:
*   **Smart Rotation Logic:** Система не ожидает новых событий пассивно. Она циклично сканирует канал-источник («Витрину»), валидирует актуальность предложений и публикует их в целевые чаты согласно индивидуальным расписаниям.
*   **Content Filtering Engine:** Встроенный алгоритм анализа контента автоматически отсеивает информационный шум (новости, опросы), допуская к публикации только коммерческие предложения (посты с Inline-кнопками).
*   **Session Failover:** При обнаружении ограничений со стороны Telegram (FloodWait) или блокировке аккаунта, система мгновенно переключает поток задач на следующий доступный аккаунт из пула.
*   **Remote Administration:** Полный цикл управления (включая добавление новых технических аккаунтов) реализован через интерфейс Telegram, исключая необходимость доступа к консоли сервера.

---

## 2. Технический стек и требования

### Окружение
*   **ОС:** Linux (Debian 11/12, Ubuntu 20.04+)
*   **Язык:** Python 3.10+
*   **СУБД:** MySQL 8.0 / MariaDB 10.5+

### Зависимости
*   `Pyrogram` (MTProto Client)
*   `aiomysql` (Asynchronous MySQL Driver)
*   `tgcrypto` (Encryption acceleration)

---

## 3. Установка и развертывание

### Этап 1. Подготовка базы данных
1.  Войдите в консоль MySQL/MariaDB.
2.  Создайте базу данных `telegram_forwarder`.
3.  Импортируйте схему данных из файла `setup_database.sql` (входит в комплект поставки).

### Этап 2. Установка ПО
1.  Разместите файлы проекта в рабочей директории на сервере.
2.  Создайте виртуальное окружение и установите зависимости:
    ```bash
    python3 -m venv venv
    source venv/bin/activate
    pip install -r requirements.txt
    ```

### Этап 3. Конфигурация
Переименуйте файл `.env.example` в `.env` и внесите корректные данные:

```ini
API_ID=123456              # Ваш App ID (my.telegram.org)
API_HASH=ваша_хэш_строка   # Ваш App Hash
DB_HOST=localhost          # Хост БД
DB_USER=root               # Пользователь БД
DB_PASS=пароль             # Пароль БД
DB_NAME=telegram_forwarder # Имя БД
ADMIN_ID=123456789         # Telegram ID администратора (ОБЯЗАТЕЛЬНО)
```
> **Важно:** Бот будет реагировать на команды **только** от пользователя с указанным `ADMIN_ID`. Узнать свой ID можно через бота `@userinfobot`.

### Этап 4. Первичный запуск
Для инициализации системы необходимо добавить **первый аккаунт** через консоль сервера (так как бот еще не запущен и не может принимать команды).

```bash
python add_account.py
```
*Следуйте инструкциям в терминале для авторизации.*

После успешного добавления первого аккаунта запустите основной сервис в фоновом режиме (рекомендуется использовать `screen` или `systemd`):

```bash
python main.py
```

---

## 4. Руководство Администратора (Управление через Telegram)

После запуска основного сервиса всё управление производится через личные сообщения с любым из подключенных ботов-аккаунтов.

### 4.1. Добавление новых аккаунтов (Интерактивный режим)
Вам не нужно заходить на сервер для масштабирования сетки. Единственным исключением является ситуация после первого запуска (когда в базе нет аккаунтов и нужно добавить хотя бы один для использования команд). В этом случае вам нужно будет запустить скрипт `python add_account.py` и авторизовать через консоль хотя бы один аккаунт (после этого скрипт можно выключить и далее пользоваться командами в чате Telegram).

1.  Отправьте команду: `/add_account`
2.  Бот запросит номер телефона. Введите его в формате `+79990000000`.
3.  Бот запросит код подтверждения. Введите цифры, пришедшие в Telegram добавляемого аккаунта.
4.  Если на аккаунте установлен облачный пароль (2FA), бот запросит его ввод.
5.  **Результат:** Система сохранит сессию в БД и автоматически перезагрузится (`Hot Reload`) для подключения нового воркера.

### 4.2. Управление источниками (Откуда брать)
*   **Команда:** `/add_source @username` или `https://t.me/link`
*   **Описание:** Добавляет канал в список мониторинга.
*   **Логика:** Бот будет сканировать последние 20 сообщений этого канала при каждом цикле ротации.
*   *Примечание:* После добавления нового источника рекомендуется выполнить команду `/restart`.

### 4.3. Управление получателями (Куда слать)
*   **Команда:** `/add_dest @link [интервал] [пачка]`
*   **Параметры:**
    *   `@link` — Ссылка на целевой чат.
    *   `[интервал]` — Минимальная пауза между публикациями в минутах.
    *   `[пачка]` — Количество постов, публикуемых за один раз.
*   **Пример:** `/add_dest @my_chat 60 3`
    *(Публиковать в чат @my_chat каждые 60 минут пакет из 3 случайных актуальных объявлений).*

### 4.4. Настройка режимов отправки
В связи с ограничениями Telegram, для разных типов чатов требуются разные методы доставки.

*   **Команда:** `/set_mode @link [0 или 1]`
*   **Режим 0 (Forward):**
    *   *Метод:* Пересылка.
    *   *Плюсы:* Сохраняются рабочие кнопки (URL, бронирование).
    *   *Минусы:* Видна ссылка на источник ("Переслано от..."). Не работает в чатах с запретом пересылки.
*   **Режим 1 (Copy):**
    *   *Метод:* Копирование контента.
    *   *Плюсы:* Выглядит как нативный пост от имени аккаунта. Работает во всех чатах.
    *   *Минусы:* **Telegram автоматически удаляет кнопки** при копировании.

### 4.5. Системные команды
*   `/list` — Вывести полную таблицу текущих настроек (источники, получатели, таймеры, режимы).
*   `/delete @link` — Удалить канал (источник или получатель) из базы данных.
*   `/send_ad https://t.me/...` — Принудительная ручная рассылка указанного поста во все чаты (игнорирует таймеры).
*   `/restart` — Полная перезагрузка ядра бота.

---

## 5. Алгоритм работы Ротатора (Deep Dive)

Для понимания принципов работы системы:

1.  **Инициализация цикла:** Бот перебирает список целевых чатов из БД.
2.  **Проверка тайминга:** Для каждого чата сравнивается `UTC Timestamp` последней отправки с заданным интервалом. Если время не пришло — чат пропускается.
3.  **Сбор контента:** Бот обращается к каналу-источнику и получает срез из последних 20 сообщений.
    *   *Авто-актуализация:* Если товар был удален из канала-источника менеджером, бот его не увидит. База данных постов не ведется, работа идет с "живой витриной".
4.  **Фильтрация:** Из полученного среза отбрасываются посты без `reply_markup` (без кнопок). Это исключает попадание в рекламу новостных и сервисных сообщений.
5.  **Выборка:** Из оставшихся валидных постов случайным образом выбирается N штук (согласно настройке `batch`).
6.  **Публикация:** Производится отправка с использованием свободного аккаунта.
7.  **Ротация:** Если аккаунт получает отказ (FloodWait/Ban), он помечается в БД соответствующим флагом, и задача мгновенно передается следующему аккаунту.

---

## 6. Устранение неполадок (Troubleshooting)

| Проблема | Возможная причина | Решение |
| :--- | :--- | :--- |
| **Бот не отвечает на команды** | Ваш Telegram ID не совпадает с `ADMIN_ID` в `.env`. | Проверьте ID через @userinfobot и обновите файл `.env`. Перезапустите бота. |
| **Сообщения приходят без кнопок** | Для чата установлен Режим 1 (Copy). | Переключите режим командой `/set_mode @chat 0`. |
| **Бот перестал постить** | Нет актуальных постов с кнопками в источнике. | Проверьте канал-донор. Убедитесь, что последние 20 постов содержат кнопки. |
| **Ошибка "FloodWait" в логах** | Слишком частая отправка. | Это штатная работа защиты. Система сама сменит аккаунт и продолжит работу. |

---
**Разработчик:** BelGray